<!DOCTYPE html>
<html>
<head>
    <title>Card Setup</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #payment-element { margin-bottom: 15px; }
        #result { margin-top: 20px; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .processing { background: #fff3cd; color: #856404; }
        h2 { margin-top: 0; color: #333; }
        button { margin-top: 15px; padding: 12px 24px; background: #5469d4; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { background: #4558c7; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Save Card</h2>
        <div id="payment-element"></div>
        <button id="submit-btn">Save Card</button>
        <div id="result"></div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const pkKey = params.get('pk') || 'pk_test_xxx';
        
        window.currentClientSecret = params.get('client_secret') || '';
        
        // Get billing info from URL params
        const billingName = params.get('name') || '';
        const billingEmail = params.get('email') || '';
        const billingStreet = params.get('street') || '';
        const billingCity = params.get('city') || '';
        const billingState = params.get('state') || '';
        const billingZip = params.get('zip') || '';
        const billingCountry = params.get('country') || 'US';
        
        const stripe = Stripe(pkKey);
        
        // Use Payment Element instead of Card Element
        const elements = stripe.elements({
            clientSecret: window.currentClientSecret,
            appearance: {
                theme: 'stripe',
                variables: {
                    colorPrimary: '#5469d4'
                }
            }
        });
        
        // Create Payment Element with card only
        const paymentElement = elements.create('payment', {
            layout: 'tabs',
            defaultValues: {
                billingDetails: {
                    name: billingName,
                    email: billingEmail,
                    address: {
                        line1: billingStreet,
                        city: billingCity,
                        state: billingState,
                        postal_code: billingZip,
                        country: billingCountry
                    }
                }
            },
            // Only show card payment method
            paymentMethodOrder: ['card']
        });
        
        paymentElement.mount('#payment-element');
        
        // Track when element is ready
        window.elementReady = false;
        paymentElement.on('ready', () => {
            window.elementReady = true;
            console.log('[PaymentElement] Ready');
        });

        window.setupResult = undefined;
        window.isProcessing = false;
        
        // Function to reset for next card (called from Playwright)
        window.resetForNextCard = function(newClientSecret) {
            window.currentClientSecret = newClientSecret;
            window.setupResult = undefined;
            window.isProcessing = false;
            document.getElementById('result').textContent = '';
            document.getElementById('result').className = '';
            document.getElementById('submit-btn').disabled = false;
            // Recreate elements with new client secret
            elements.update({ clientSecret: newClientSecret });
            return true;
        };
        
        async function submitCard() {
            const resultDiv = document.getElementById('result');
            const submitBtn = document.getElementById('submit-btn');
            
            if (window.isProcessing) return;
            window.isProcessing = true;
            window.setupResult = undefined;
            resultDiv.textContent = 'Processing...';
            resultDiv.className = 'processing';
            submitBtn.disabled = true;

            try {
                // Confirm SetupIntent with Payment Element
                const { setupIntent, error } = await stripe.confirmSetup({
                    elements,
                    confirmParams: {
                        return_url: window.location.href
                    },
                    redirect: 'if_required'
                });

                if (error) {
                    resultDiv.textContent = 'ERROR:' + error.message;
                    resultDiv.className = 'error';
                    window.setupResult = { 
                        error: error.message,
                        code: error.code,
                        declineCode: error.decline_code
                    };
                } else {
                    const pm = setupIntent.payment_method;
                    resultDiv.textContent = 'SUCCESS:' + setupIntent.id;
                    resultDiv.className = 'success';
                    window.setupResult = { 
                        setupIntentId: setupIntent.id,
                        paymentMethodId: pm,
                        status: setupIntent.status
                    };
                }
            } catch (e) {
                resultDiv.textContent = 'ERROR:' + e.message;
                resultDiv.className = 'error';
                window.setupResult = { error: e.message };
            } finally {
                window.isProcessing = false;
                submitBtn.disabled = false;
            }
        }
        
        document.getElementById('submit-btn').addEventListener('click', submitCard);
    </script>
</body>
</html>
